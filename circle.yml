machine:
  node:
    version: 6.3.0

dependencies:
  cache_directories:
    - ./src/node_modules
  override:
    - npm install:
        pwd:
          ./src
    - npm install -g mocha mocha-junit-reporter

test:
  pre:
    - mkdir -p $CIRCLE_TEST_REPORTS/shatner
  override:
    - NODE_ENV=test mocha --ui qunit --recursive --reporter mocha-junit-reporter --reporter-options mochaFile=$CIRCLE_TEST_REPORTS/shatner/junit.xml ./src/test

deployment:
  master:
    branch: master
    commands:
      - rsync -avz ./ops $REMOTE_USER@$REMOTE_SERVER:$REMOTE_DIR
      - rsync -avz ./src $REMOTE_USER@$REMOTE_SERVER:$REMOTE_DIR
      - ssh -t $REMOTE_USER@$REMOTE_SERVER "sudo $REMOTE_DIR/ops/setup.sh"
